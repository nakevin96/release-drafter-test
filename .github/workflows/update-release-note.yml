name: Auto Release Notes

on:
  pull_request:
    types: [closed]
    branches:
      - 'RB-*'

jobs:
  update-release-notes:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}

      - name: Get branch name and version
        run: |
          BRANCH=${GITHUB_BASE_REF#RB-}
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV
          echo "VERSION=$BRANCH" >> $GITHUB_ENV

      - name: Get PR details
        run: |
          echo "PR_TITLE=${{ github.event.pull_request.title }}" >> $GITHUB_ENV
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          echo "PR_LABELS=$(echo '${{ toJson(github.event.pull_request.labels.*.name) }}' | jq -c)" >> $GITHUB_ENV
          echo "COMPARE_BRANCH=${{ github.event.pull_request.head.ref }}" >> $GITHUB_ENV

      - name: Update or create release notes
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
        run: |
          set -e
          
          release_id=$(gh release view $VERSION --json id -q .id 2>/dev/null || echo '')
          
          # Check if PR should be skipped
          if echo "$PR_LABELS" | jq -e 'contains(["skip-release-note"])' > /dev/null; then
            echo "Skipping release note for this PR"
            exit 0
          fi
          
          # Initialize template
          template="
          ## WEB
          ### Changes
          ### Bug fixes
          ### etc

          ## ADMIN
          ### Changes
          ### Bug fixes
          ### etc

          ## COMMON
          ### Changes
          ### Bug fixes
          ### etc

          ## ETC
          "
          
          # Determine category and subcategory
          category="ETC"
          subcategory=""
          
          if echo "$PR_LABELS" | jq -e 'map(select(startswith("common-"))) | length > 0' > /dev/null; then
            category="COMMON"
          elif echo "$PR_LABELS" | jq -e 'contains(["ntrance_web"])' > /dev/null; then
            category="WEB"
          elif echo "$PR_LABELS" | jq -e 'contains(["ntrance_admin"])' > /dev/null; then
            category="ADMIN"
          fi

          if [[ "$COMPARE_BRANCH" == feat* ]]; then
            subcategory="Changes"
          elif [[ "$COMPARE_BRANCH" == fix* || "$COMPARE_BRANCH" == membersus* || "$COMPARE_BRANCH" == jira* ]]; then
            subcategory="Bug fixes"
          else
            subcategory="etc"
          fi
          
          echo "Category: $category, Subcategory: $subcategory"
          
          # Prepare new content
          new_content="- $PR_TITLE (#$PR_NUMBER)"
          
          if [ -z "$release_id" ]; then
            echo "$template" > release_notes.md
            if [ "$category" == "ETC" ]; then
              sed -i "s/## ETC/## ETC\n$new_content/" release_notes.md
            else
              sed -i "/## $category/,/## / s/### $subcategory/### $subcategory\n$new_content/" release_notes.md
            fi
            # Remove empty sections
            sed -i '/### Changes/{n;/### Bug fixes/d;}' release_notes.md
            sed -i '/### Bug fixes/{n;/### etc/d;}' release_notes.md
            sed -i '/### etc/{n;/^$/d;}' release_notes.md
            gh release create $VERSION --draft --title "$VERSION" --notes-file release_notes.md
          else
            gh release view $VERSION --json body -q .body > release_notes.md
            if [ "$category" == "ETC" ]; then
              sed -i "/## ETC/a $new_content" release_notes.md
            else
              sed -i "/## $category/,/## / s/### $subcategory/### $subcategory\n$new_content/" release_notes.md
            fi
            gh release edit $VERSION --notes-file release_notes.md
          fi
        continue-on-error: false
